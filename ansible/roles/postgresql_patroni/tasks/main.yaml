---
- name: ensure dnf cache is up to date
  ansible.builtin.dnf: 
    update_cache: true

- name: Reset postgres module list
  ansible.builtin.shell: yes | dnf module reset postgresql

- name: Enable PostgreSQL {{postgresql_version}} module
  ansible.builtin.shell: yes | dnf module enable postgresql:{{postgresql_version}}

- name: Install Postgresql
  ansible.builtin.dnf:
    name: 
      - postgresql-server
      - postgresql-contrib
      - python3-pip
    state: latest

- name: Install Postgresql
  ansible.builtin.dnf:
    name: 
      - python3-psycopg2
      - pgaudit
    state: latest

- name: Install Patroni via pip
  pip:
    name: patroni[etcd]
    executable: pip3

- name: Create Patroni config
  template:
    src: patroni.yml.j2
    dest: /etc/patroni.yml
    mode: 0644
  
- name: Restart patroni patroni
  systemd:
    name: patroni
    state: restarted

- name: Create systemd unit for Patroni
  template:
    src: patroni.service.j2
    dest: /etc/systemd/system/patroni.service
    mode: 0644
  
- name: Reload systemd
  systemd:
    daemon_reload: yes

- name: Enable and start Patroni
  systemd:
    name: patroni
    enabled: yes
    state: started